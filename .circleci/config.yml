version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/jobs-steps/#jobs-overview & https://circleci.com/docs/configuration-reference/#jobs
jobs:
  arm-clang:
    docker:
      - image: cimg/base:current
    resource_class: small      
    environment:
      TOOLCHAIN_URL: https://github.com/ARM-software/LLVM-embedded-toolchain-for-Arm/releases/download/release-17.0.1/LLVMEmbeddedToolchainForArm-17.0.1-Linux-x86_64.tar.xz

    steps:
      # Checkout the code as the first step.
      - checkout
      - run:
          name: Install Toolchain
          command: |
            mkdir -p ~/cache/toolchain
            wget --progress=dot:mega $TOOLCHAIN_URL -O toolchain.tar.gz
            tar -C ~/cache/toolchain -xaf toolchain.tar.gz
      - run:
          name: Set Toolchain Path
          command: echo `echo ~/cache/toolchain/*/bin`  >> $BASH_ENV
      - run:
          name: Get Dependencies
          command: |
            sudo apt install -y ninja-build
            python tools/get_deps.py stm32f1
      - run:
          name: Build
          command: python tools/build.py -s cmake --toolchain clang stm32f1
 

# Orchestrate jobs using workflows
# See: https://circleci.com/docs/workflows/ & https://circleci.com/docs/configuration-reference/#workflows
workflows:
  build: # This is the name of the workflow, feel free to change it to better match your workflow.
    # Inside the workflow, you define the jobs you want to run.
    jobs:
      - arm-clang
