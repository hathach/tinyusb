version: 2.1

setup: true
orbs:
  continuation: circleci/continuation@1

jobs:
  set-matrix:
    executor: continuation/default
    docker:
      - image: cimg/base:current
    resource_class: small
    steps:
      - checkout
      - run:
          name: Set matrix
          command: |
            MATRIX_JSON=$(python .github/workflows/ci_set_matrix.py)
            echo "MATRIX_JSON=$MATRIX_JSON"
            ARMCLANG_FAMILY=$(echo $MATRIX_JSON | jq '.["arm-clang"].family')
            echo "ARMCLANG_FAMILY=$ARMCLANG_FAMILY"
            echo "              build-system: ['cmake']" >> .circleci/config2.yml
            echo "              family: $ARMCLANG_FAMILY" >> .circleci/config2.yml

      - continuation/continue:
          configuration_path: .circleci/config2.yml

workflows:
  set-matrix-workflow:
    jobs:
      - set-matrix
